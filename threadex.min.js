var latest_version_directory="data/v14.5",prev_version_directory="data/v13.3";function postSuccess(t,e){$("#progressbar").hide(),t?t.error?alert(t.error):e(t):alert("No results for request")}function postError(){$("#progressbar").hide(),alert("Error processing request; please try again")}function postResults(t,e,a){var r,s,i="http://data.rcc-acis.org"+e;window.XDomainRequest?((r=new XDomainRequest).open("GET",i+"?params="+JSON.stringify(t)),r.onload=function(){postSuccess(JSON.parse(r.responseText),a)},r.onerror=postError,r.onprogress=function(){},r.ontimeout=function(){},setTimeout(function(){r.send()},0)):(s={params:JSON.stringify(t),output:"json"},$.ajax(i,{type:"POST",data:s,dataType:"json",crossDamain:!0,success:function(t){postSuccess(t,a)},error:postError}))}function urlopts(){var t,e,a={},r=["himaxt","lomaxt","himint","lomint","hipcpn","archivehimaxt","archivelomaxt","archivehimint","archivelomint","archivehipcpn","changes","covmaxt","covmint","covpcpn","thread"],s=window.location.search.slice(1).split("&");for(t=0;t<s.length;t+=1)("thr_id"===(e=s[t].split("="))[0]&&6===e[1].length||"variable"===e[0]&&$.inArray(e[1].toLowerCase(),r)>=0)&&(a[e[0]]=e[1]);return a}function fixTraces(t){var e,a,r,s,i,n=$("#selected_report").text(),o=t.meta.valid_daterange[0],d=function(t){return t%4==0&&t%100!=0||t%400==0},p=function(t){var e,a,r,s,i,n,o,d=[],p=[],l=[],c=$.grep(t.data,function(t,e){return t[0].search("-02-29")>0});for(c.length&&(t.data=c),e=t.data.length-1;e>=0;e-=1)r=t.data[e][0],"T"===(s=t.data[e][1])?d.push([s,r]):"0.00"===s?p.push([s,r]):"M"!=s&&l.push([s,r]);for($.merge($.merge(l,d),p),a=0;a<=2;a+=1)"0.00"!==(n=l.shift())[0]&&"T"!==n[0]||(o=("T"===n[0]?"Trace":n[0])+" in "+n[1].slice(0,4),i=n[1].split("-"),2===a&&l.shift()[0]===n[0]&&(o+="+"),$("#results_table tbody tr td").filter(function(){return $(this).text()===parseInt(i[1])+"/"+parseInt(i[2])}).closest("tr").find("td").eq(a+1).text(o))};if(n.search("precipitation")>=0)for(e=0;e<366;e+=1)if("0.00"===(a=t.smry[0][e])[2][0]||"T"===a[2][0]){if(r=a[0][1].split("-"),s=parseInt(o[0].split("-")[0]),i=parseInt(o[1].split("-")[0]),2===parseInt(r[1])&&29===parseInt(r[2])){for(;!d(s);)s-=1;for(;!d(i);)i+=1}postResults({sid:$("#thr_id").val(),sdate:s.toString()+"-"+r[1]+"-"+r[2],edate:i.toString()+"-"+r[1]+"-"+r[2],elems:[{name:"pcpn",interval:[1,0,0],duration:1}],meta:[]},"/StnData",p)}}function addGraph(t,e){$("#results_area").append('<div id="chart-container"></div>'),Highcharts.chart("chart-container",{chart:{type:"columnrange",inverted:!0,zoomType:"xy",spacingBottom:20,borderWidth:1},title:{text:"Range Between 1st and 3rd Record Values",style:{fontSize:"14px"}},subtitle:{text:"Click and drag to zoom in"},credits:{text:"Powered by ACIS",href:"http://www.rcc-acis.org"},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%b %e",week:"%b %e",month:"%b %e"},gridLineWidth:1,showLastLabel:!1},yAxis:{title:{text:e},floor:e.search("precipitation")>=0?0:null},legend:{enabled:!1},tooltip:{dateTimeLabelFormats:{day:"%b %e",week:"%b %e",month:"%b %e"},valueDecimals:e.search("precipitation")>=0?2:0,formatter:function(){return"Range of records for "+Highcharts.dateFormat("%b %e",new Date(this.x))+": "+this.point.low+" to "+this.point.high}},series:[{name:"Range of records",data:t,pointStart:Date.UTC(2016,0,1),pointInterval:864e5}]})}function addToGraphSeries(t,e,a){var r=t[0][0],s=t[2][0];return r===s&&a.search("temperature")>=0?a.search("Highest")>=0?e.push([parseFloat(r)+.2,parseFloat(s)-.2]):e.push([parseFloat(r)-.2,parseFloat(s)+.2]):(r=a.search("precipitation")>=0&&("T"===r||"Trace"===r)?0:parseFloat(r),s=a.search("precipitation")>=0&&("T"===s||"Trace"===s)?0:parseFloat(s),e.push([r,s])),e}function displayRecords(t){var e,a,r,s,i,n,o=!1,d=t.meta,p=$("#selected_report").text(),l=p+(p.search("temperature")>=0?" (degrees F)":" (inches)"),c=[];for($("#results_area").append('<table id="results_table" class="abreast"><caption></caption><thead></thead><tbody></tbody><tfoot></tfoot></table>'),$("#results_table caption").append(d.name+", "+d.state+'<br /><span class="subcaption">Period of record: '+d.valid_daterange[0][0]+" through "+d.valid_daterange[0][1]+"</span>"),$("#results_table thead").append("<tr><th rowspan=2>Date<th colspan=3>"+l+"</tr><tr><th>Top Record <th>2nd Record <th>3rd Record</tr>"),e=0;e<366;e+=1)r=(a=t.smry[0][e])[0][1].split("-"),i=parseInt(r[1])%2==1?"WhiteSmoke":"white",a[2][0]===a[3][0]?(n="+",o=!0):n="",s='<tr style="background-color: '+i+';"><td>'+parseInt(r[1])+"/"+parseInt(r[2]),s+="<td>"+("T"===a[0][0]||"0.00"===a[0][0]?"processing":a[0][0]+" in "+r[0]),s+="<td>"+("T"===a[1][0]||"0.00"===a[1][0]?"processing":a[1][0]+" in "+a[1][1].slice(0,4)),s+="<td>"+("T"===a[2][0]||"0.00"===a[2][0]?"processing":a[2][0]+" in "+a[2][1].slice(0,4)+n)+"</tr>",$("#results_table tbody").append(s),c=addToGraphSeries(a,c,l);o&&$("#results_area tfoot").append("<tr><td colspan=4>+ indicates same value also occurred in a previous year.</tr>"),fixTraces(t),addGraph(c,l)}function displayCoverage(t){var e,a,r,s,i,n,o,d=t.meta,p=t.data,l=$("#selected_report").text().replace("data coverage"," - Missing days per month"),c=function(t,e){return new Date(parseInt(t),e+1,0).getDate()};for($("#results_area").append('<table id="results_table" class="coverage_table"><caption></caption><thead></thead><tbody></tbody></table>'),$("#results_table caption").append(d.name+", "+d.state),$("#results_table thead").append("<tr><th rowspan=2>Year<th colspan=12>"+l+"</tr><tr><th>Jan<th>Feb<th>Mar<th>Apr<th>May<th>Jun<th>Jul<th>Aug<th>Sep<th>Oct<th>Nov<th>Dec</tr>"),e=0;e<p.length;e+=1){for(o=p[e][0],r=p[e][1],n="",a=0;a<12;a+=1)"M"===r[a]?(s=c(o,a),i="red"):0===r[a][1]?(s="-",i="green"):(s=r[a][1],i=r[a][1]===c(o,a)?"red":"yellow"),n+='<td style="background-color:'+i+';">'+s+"</td>";$("#results_table tbody").append("<tr><td>"+o+"</td>"+n+"</tr>")}}function displayArchiveRecords(t,e,a){var r,s,i,n,o,d,p=!1,l=$("#report").val(),c=("None selected"!==$("#selected_station").text()?$("#selected_station").text():$("#thr_id").find(".ui-menu-item[data-value='"+$("#thr_id").val()+"']").text()).split(" - "),h=$("#selected_report").text(),u=h+(h.search("temperature")>=0?" (degrees F)":" (inches)"),m=[];for($("#results_area").append('<table id="results_table" class="abreast"><caption></caption><thead></thead><tbody></tbody><tfoot></tfoot></table>'),$("#results_table caption").append(c[1]+" Area, "+c[0]+'<br /><span class="subcaption">Version: '+e+" (created "+a+')</span><br /><span class="subcaption">Period of record: '+t.start_yr+" through "+t.end_yr+"</span>"),$("#results_table thead").append("<tr><th rowspan=2>Date<th colspan=3>"+u+"</tr><tr><th>Top Record <th>2nd Record <th>3rd Record</tr>"),r=0;r<366;r+=1)i=(s=t.data[r])[0][1].split("-"),o=parseInt(i[1])%2==1?"WhiteSmoke":"white",s[3]?(d="+",p=!0):d="","archivehipcpn"===l&&(s[0][0]=-1===s[0][0]?"Trace":s[0][0].toFixed(2),s[1][0]=-1===s[1][0]?"Trace":s[1][0].toFixed(2),s[2][0]=-1===s[2][0]?"Trace":s[2][0].toFixed(2)),n='<tr style="background-color: '+o+';"><td>'+parseInt(i[1])+"/"+parseInt(i[2]),n+="<td>"+s[0][0]+" in "+i[0],n+="<td>"+s[1][0]+" in "+s[1][1].slice(0,4),n+="<td>"+s[2][0]+" in "+s[2][1].slice(0,4)+d+"</tr>",$("#results_table tbody").append(n),m=addToGraphSeries(s,m,u);p&&$("#results_area tfoot").append("<tr><td colspan=4>+ indicates same value also occurred in a previous year.</tr>"),addGraph(m,u)}function initChangeTable(t,e){var a=("None selected"!==$("#selected_station").text()?$("#selected_station").text():$("#thr_id").find(".ui-menu-item[data-value='"+$("#thr_id").val()+"']").text()).split(" - ");$("#results_area").append('<table id="results_table" style="display:none;"><caption></caption></table>'),$("#results_table caption").append("ThreadEx Record Changes From Version "+t+" to "+("Current"!==e?"Version ":"")+e+" for "+a[1]+" Area, "+a[0]+'<br /><span class="subcaption">Current'+("Current"!==e?" Version "+e+"; ":"; ")+'Period of record: <span id="lsy"></span> - <span id="ley"></span></span><br /><span class="subcaption">Previous Version: '+t+'; Period of record: <span id="psy"></span> - <span id="pey"></span></span>'),$.each({himaxt:"Highest maximum temperature (deg F)",lomint:"Lowest minimum temperature (deg F)",lomaxt:"Lowest maximum temperature (deg F)",himint:"Highest minimum temperature (deg F)",hipcpn:"Highest precipitation (inches)"},function(t,e){$("#results_table").append('<tbody id="'+t+'"></tbody>'),$("#"+t).append('<tr style="background-color:WhiteSmoke;"><th colspan=5>'+e+"</tr>")})}function displayChanges(t,e,a){var r,s,i,n,o,d,p,l;if($("#psy").text(a[0]),$("#pey").text(a[1]),$("#lsy").text(a[2]),$("#ley").text(a[3]),$("#results_table").show(),0===e.length)$("#"+t).append("<tr><td colspan=5>None</tr>");else for($("#"+t).append('<tr style="background-color:WhiteSmoke;"><th>Date<th>Current Record <th>Year <th>Previous Record <th>Year</tr>'),r=0;r<e.length;r+=1)s=e[r][0],n=e[r][2],d=e[r][4],"hipcpn"===s?(i="Trace"===e[r][1]?"Trace":e[r][1].toFixed(2),o="Trace"===e[r][3]?"Trace":e[r][3].toFixed(2)):(i=e[r][1],o=e[r][3]),p=i!==o?"red":"black",l=i===o?"red":"black",$("#"+s).append("<tr><td>"+parseInt(n[1])+"/"+parseInt(n[2])+'<td style="color:'+p+';">'+i+'<td style="color:'+l+';">'+n[0]+"<td>"+o+"<td>"+d[0]+"</tr>");"hipcpn"===t&&$("#progressbar").hide()}function displayThreads(t){var e,a=("None selected"!==$("#selected_station").text()?$("#selected_station").text():$("#thr_id").find(".ui-menu-item[data-value='"+$("#thr_id").val()+"']").text()).split(" - ");for($("#results_area").append('<table id="results_table" class="threads_table"><caption></caption><thead></thead><tbody></tbody></table>'),$("#results_table caption").append("Station Thread for "+a[1]+" Area, "+a[0]),$("#results_table thead").append("<tr><th><th>Name<th>Period in Thread</tr>"),e=0;e<t.length;e+=1)$("#results_table tbody").append("<tr><td>"+(e+1)+"<td>"+t[e].name+"<td>"+t[e].period+"</tr>")}function getCoverage(){postResults({sid:$("#thr_id").val(),sdate:"por",edate:"por",elems:[{name:$("#report").val().slice(-4),interval:"mly",duration:"mly",reduce:{reduce:"cnt_ge_-999",add:"mcnt"},groupby:["year"]}],meta:["name","state","valid_daterange"]},"/StnData",displayCoverage)}function getRecords(){postResults({sid:$("#thr_id").val(),sdate:"por",edate:"por",elems:[{name:$("#report").val().slice(-4),interval:"dly",duration:"dly",smry:{reduce:"hi"===$("#report").val().slice(-6,-4)?"max":"min",add:"date",n:4},smry_only:1,groupby:["year","01-01","12-31"]}],meta:["name","state","valid_daterange"]},"/StnData",displayRecords)}function getArchiveRecords(){var t=$("#thr_id").val(),e=$("#report").val().replace("archive","");$.get("./"+latest_version_directory+"/"+e+"_records.json",function(e){$("#progressbar").hide(),displayArchiveRecords(e[t],e.version,e.creationdate)})}function getChanges(){var t=$("#thr_id").val(),e=9999,a=0,r=9999,s=0;initChangeTable(prev_version_directory.substr(6),latest_version_directory.substr(6)),$.each(["himaxt","lomint","lomaxt","himint","hipcpn"],function(i,n){var o,d,p,l,c,h,u,m=[];$.get("./"+latest_version_directory+"/"+n+"_records.json",function(i){d=i[t],e=Math.min(e,parseInt(d.start_yr)),a=Math.max(a,parseInt(d.end_yr)),$.get("./"+prev_version_directory+"/"+n+"_records.json",function(i){if(i.hasOwnProperty(t))for(c=i[t],r=Math.min(r,c.start_yr),s=Math.max(s,c.end_yr),o=0;o<366;o+=1)p=d.data[o][0][0],"hipcpn"===n&&-1===p&&(p="Trace"),l=d.data[o][0][1].split("-"),h=c.data[o][0][0],"hipcpn"===n&&-1===h&&(h="Trace"),u=c.data[o][0][1].split("-"),p===h&&l[0]===u[0]||m.push([n,p,l,h,u]);else r="-",s="-";displayChanges(n,m,[r,s,e,a])})})})}function getRecentChanges(){var t=9999,e=0,a=9999,r=0,s=$("#thr_id").val(),i={sid:s,sdate:"por",edate:"por",elems:[{name:null,interval:"dly",duration:"dly",smry:{reduce:null,add:"date"},smry_only:1,groupby:["year","01-01","12-31"]}],meta:["name","state","valid_daterange"]};initChangeTable(latest_version_directory.substr(6),"Current"),$.each(["himaxt","lomint","lomaxt","himint","hipcpn"],function(n,o){var d,p,l,c,h,u,m=[];$.get("./"+latest_version_directory+"/"+o+"_records.json",function(n){p=n[s],t=Math.min(t,parseInt(p.start_yr)),e=Math.max(e,parseInt(p.end_yr)),i.elems[0].name=o.slice(-4),i.elems[0].smry.reduce="hi"===o.slice(-6,-4)?"max":"min",postResults(i,"/StnData",function(s){var i=s.meta.valid_daterange[0][0].split("-"),n=s.meta.valid_daterange[0][1].split("-");for(a=Math.min(a,parseInt(i[0])),r=Math.max(r,parseInt(n[0])),d=0;d<366;d+=1)l=p.data[d][0][0],"hipcpn"===o&&-1===l&&(l="Trace"),c=p.data[d][0][1].split("-"),h="hipcpn"===o&&"T"===s.smry[0][d][0]?"Trace":parseFloat(s.smry[0][d][0]),u=s.smry[0][d][1].split("-"),l===h&&c[0]===u[0]||m.push([o,h,u,l,c]);displayChanges(o,m,[t,e,a,r])})})})}function getThreads(){var t=$("#thr_id").val().replace("thr","");$.get("./data/threads_dict.json",function(e){$("#progressbar").hide(),displayThreads(e[t])})}$(function(){var t=function(t,e){var a=$(this).prev("button");if(e.item.attr("class").search("noselect")>=0)return $(this).trigger("click"),!1;a.show().text(a.text().replace("Select","Change")),$(this).val(e.item.data("value")).hide(),$(this).parent().find("span").html(e.item.text()),$("#results_area").empty()};$("#thr_id").val("BHMthr").menu({select:t}),$("#report").val("thread").menu({items:"> :not(.ui-widget-header)",select:t}),$(".show_menu").button().on("click",function(){$(this).next("ul").show(),$(this).prev("span").empty(),$(this).hide()}),$("#go").button().on("click",function(){var t=$("#report").val();$("#results_area").empty(),$("#progressbar").show(),$.inArray(t,["himaxt","lomaxt","himint","lomint","hipcpn"])>=0?getRecords():$.inArray(t,["archivehimaxt","archivelomaxt","archivehimint","archivelomint","archivehipcpn"])>=0?getArchiveRecords():"changes"===t?getChanges():"recentchanges"===t?getRecentChanges():$.inArray(t,["covmaxt","covmint","covpcpn"])>=0?getCoverage():"thread"===t?getThreads():($("#results_area").append("<p>Selection not implemented</p>"),$("#progressbar").hide())}),$("#progressbar").progressbar({value:!1,disabled:!0}),$("#info").dialog({autoOpen:!1,modal:!0,width:.9*$(window).width(),maxHeight:.9*$(window).height(),position:{my:"center top",at:"center top",of:$("div.option-container")},buttons:[{text:"Close",click:function(){$(this).dialog("close")}}]}),$("#about").button().on("click",function(){$("#info").load("./help/about.html").dialog("option","title","Project Information").dialog("open")}),$("#report_info").on("click",function(){$("#info").load("./help/report_help.html").dialog("option","title","Report Options").dialog("open")}),$.ui.dialog.prototype._focusTabbable=$.noop;var e=urlopts();"thr_id"in e&&"variable"in e&&(e.thr_id=e.thr_id.substr(0,3).toUpperCase()+e.thr_id.substr(3).toLowerCase(),$("#thr_id").val(e.thr_id),$("#selected_station").text($("#thr_id li[data-value="+e.thr_id+"]").text()),e.variable=e.variable.toLowerCase(),$("#report").val(e.variable),$("#selected_report").text($("#report li[data-value="+e.variable+"]").text()),$("#go").trigger("click"))});